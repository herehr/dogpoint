generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id    String @id @default(cuid())
  email String @unique
  role  Role   @default(USER)

  passwordHash String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  animalsApproved Animal[]       @relation("AnimalApprovedBy")
  animalsCreated  Animal[]       @relation("AnimalCreatedBy")
  notifications   Notification[]
  postsApproved   Post[]         @relation("PostApprovedBy")
  posts           Post[]         @relation("AuthorPosts")
  postsCreated    Post[]         @relation("PostCreatedBy")
  subscriptions   Subscription[]

  firstName String?
  lastName  String?
  street    String?
  streetNo  String?
  zip       String?
  city      String?

  taxRequestSentAt DateTime?
  taxRequestCount  Int       @default(0)

  taxProfile TaxProfile?
  taxTokens  TaxRequestToken[]
}

model Animal {
  id               String            @id @default(cuid())
  name             String?
  description      String?
  updatedAt        DateTime          @updatedAt
  active           Boolean           @default(true)
  createdAt        DateTime          @default(now())
  jmeno            String?
  main             String?
  popis            String?
  charakteristik   String?
  birthDate        DateTime?
  bornYear         Int?
  approvedById     String?
  createdById      String?
  status           ContentStatus     @default(PENDING_REVIEW)
  adoptionRequests AdoptionRequest[]
  approvedBy       User?             @relation("AnimalApprovedBy", fields: [approvedById], references: [id])
  createdBy        User?             @relation("AnimalCreatedBy", fields: [createdById], references: [id])
  galerie          GalerieMedia[]
  notifications    Notification[]
  posts            Post[]
  subscriptions    Subscription[]

  @@index([status])
}

model GalerieMedia {
  id        String   @id @default(cuid())
  url       String
  animalId  String?
  createdAt DateTime @default(now())
  typ       String   @default("image")
  animal    Animal?  @relation(fields: [animalId], references: [id], onDelete: Cascade)
}

model AdoptionRequest {
  id                      String    @id @default(cuid())
  animalId                String
  name                    String
  email                   String
  phone                   String?
  message                 String?
  status                  String    @default("NEW")
  monthly                 Int?
  lastViewedAt            DateTime?
  lastSeenAt              DateTime?
  endedAt                 DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  stripeCustomerId        String?
  stripeSubscriptionId    String?
  stripeCheckoutSessionId String?
  animal                  Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@index([animalId])
  @@index([email, animalId])
}

model TaxProfile {
  id String @id @default(cuid())

  // 1:1 with User (optional on User side)
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // If tax subject is a company
  isCompany   Boolean @default(false)
  companyName String?
  taxId       String?

  // If tax subject is a different physical person (or fallback address)
  firstName String?
  lastName  String?

  // Address (always here, because tax subject may differ from User)
  street   String?
  streetNo String?
  zip      String?
  city     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isCompany])
  @@index([taxId])
}

model TaxRequestToken {
  id String @id @default(cuid())

  token String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  usedAt    DateTime?
  expiresAt DateTime

  sentAt    DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model Post {
  id            String         @id @default(cuid())
  title         String
  body          String?
  active        Boolean        @default(true)
  animalId      String
  authorId      String?
  createdAt     DateTime       @default(now())
  publishedAt   DateTime       @default(now())
  approvedById  String?
  createdById   String?
  status        ContentStatus  @default(PENDING_REVIEW)
  updatedAt     DateTime       @default(now()) @updatedAt
  notifications Notification[]
  animal        Animal         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  approvedBy    User?          @relation("PostApprovedBy", fields: [approvedById], references: [id])
  author        User?          @relation("AuthorPosts", fields: [authorId], references: [id])
  createdBy     User?          @relation("PostCreatedBy", fields: [createdById], references: [id])
  media         PostMedia[]

  @@index([status])
}

model PostMedia {
  id        String   @id @default(cuid())
  url       String
  typ       String   @default("image")
  postId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Subscription {
  id             String             @id @default(cuid())
  userId         String
  animalId       String
  monthlyAmount  Int
  currency       String             @default("CZK")
  provider       PaymentProvider
  providerRef    String?
  variableSymbol String?            @unique
  message        String?
  status         SubscriptionStatus @default(PENDING)
  startedAt      DateTime           @default(now())
  canceledAt     DateTime?
  note           String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  payments       Payment[]
  animal         Animal             @relation(fields: [animalId], references: [id], onDelete: Cascade)
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, animalId, status])
  @@index([userId])
  @@index([animalId])
  @@index([status])
}

model Payment {
  id             String          @id @default(cuid())
  subscriptionId String
  provider       PaymentProvider
  providerRef    String?
  amount         Int
  currency       String          @default("CZK")
  status         PaymentStatus
  paidAt         DateTime?
  failureReason  String?
  createdAt      DateTime        @default(now())
  subscription   Subscription    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  readAt    DateTime?
  createdAt DateTime  @default(now())
  animalId  String?
  postId    String?
  animal    Animal?   @relation(fields: [animalId], references: [id])
  post      Post?     @relation(fields: [postId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
  @@index([userId, readAt])
  @@index([userId, createdAt])
}

model WebhookEvent {
  id         String          @id @default(cuid())
  provider   PaymentProvider
  rawPayload Json
  processed  Boolean         @default(false)
  createdAt  DateTime        @default(now())
}

model FioCursor {
  id        Int      @id @default(1)
  lastId    String?
  updatedAt DateTime @updatedAt
}

model Pledge {
  id         String          @id @default(cuid())
  animalId   String
  email      String
  name       String?
  amount     Int
  interval   PaymentInterval @default(MONTHLY)
  method     PaymentMethod
  status     PaymentStatus   @default(PENDING)
  providerId String?
  note       String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  payments   PledgePayment[]

  @@index([email, animalId])
  @@index([status, method])
}

model PledgePayment {
  id            String        @id @default(cuid())
  pledgeId      String
  status        PaymentStatus
  amount        Int
  provider      String?
  providerId    String?
  raw           Json?
  createdAt     DateTime      @default(now())
  currency      String        @default("CZK")
  md            String?
  orderNumber   String?       @unique
  paidAt        DateTime?
  redirectUrl   String?
  resultCode    String?
  resultMessage String?
  pledge        Pledge        @relation(fields: [pledgeId], references: [id], onDelete: Cascade)

  @@index([pledgeId])
  @@index([status])
  @@index([orderNumber])
}

enum Role {
  ADMIN
  MODERATOR
  USER
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  MOCK
  FIO
  GPWEBPAY
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  PAUSED
  CANCELED
}

enum PaymentStatus {
  PENDING
  PAID
  REQUIRES_ACTION
  CANCELED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  BANK
}

enum PaymentInterval {
  MONTHLY
}

enum ContentStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  REJECTED
}
